From 6659d59e66e58526e7b374085f5d8141918c3931 Mon Sep 17 00:00:00 2001
From: Colin Walters <walters@verbum.org>
Date: Wed, 23 May 2012 10:19:09 -0400
Subject: [PATCH] build: Implement GNOME Build API for wpa_supplicant

See http://people.gnome.org/~walters/docs/build-api.txt
---
 Makefile                |   15 ++++++++++++++
 configure               |   50 +++++++++++++++++++++++++++++++++++++++++++++++
 wpa_supplicant/Makefile |   33 ++++++++++++++++++++++++++----
 3 files changed, 93 insertions(+), 5 deletions(-)
 create mode 100644 Makefile
 create mode 100755 configure

diff --git a/Makefile b/Makefile
new file mode 100644
index 0000000..0707897
--- /dev/null
+++ b/Makefile
@@ -0,0 +1,15 @@
+# Stub makefile to build wpa_supplicant
+#
+# Copyright 2012 Colin Walters <walters@verbum.org>
+# 
+# This software may be distributed under the terms of the BSD license.
+# See README for more details.
+
+all:
+	$(MAKE) -C src/utils
+	$(MAKE) -C wpa_supplicant
+
+install:
+	$(MAKE) -C wpa_supplicant install
+
+.NOTPARALLEL:
diff --git a/configure b/configure
new file mode 100755
index 0000000..8228bd0
--- /dev/null
+++ b/configure
@@ -0,0 +1,50 @@
+#!/usr/bin/env python
+# Copyright 2012 Colin Walters <walters@verbum.org>
+# 
+# This software may be distributed under the terms of the BSD license.
+# See README for more details.
+#
+# This file implements the GNOME Build API:
+# http://people.gnome.org/~walters/docs/build-api.txt
+
+# We don't support srcdir != builddir
+#buildapi-variable-no-builddir
+
+import os,sys,argparse
+
+def _write_makefile_key(f, key, value):
+    f.write(key)
+    f.write('=')
+    f.write(value)
+    f.write('\n')
+
+def main():
+    parser = argparse.ArgumentParser(description="Configure wpa_supplicant")
+    parser.add_argument('--sysconfdir')
+    parser.add_argument('--prefix')
+    parser.add_argument('--bindir')
+    parser.add_argument('--libdir')
+    
+    (args, other) = parser.parse_known_args()
+
+    prefix = args.prefix or '/usr/local'
+    sysconfdir = args.sysconfdir or os.path.join(prefix, 'etc')
+    bindir = args.bindir or os.path.join(prefix, 'bin')
+    libdir = args.bindir or os.path.join(prefix, 'lib')
+
+    config_path = os.path.join(os.getcwd(), 'wpa_supplicant', '.config')
+    if not os.path.exists(config_path):
+        print "You must create a wpa_supplicant/.config file"
+        sys.exit(1)
+    
+    makefile_inc_path = os.path.join(os.getcwd(), 'Makefile.inc')
+    f = open(makefile_inc_path, 'w')
+    _write_makefile_key(f, 'PREFIX', prefix)
+    _write_makefile_key(f, 'SYSCONFDIR', sysconfdir)
+    _write_makefile_key(f, 'LIBDIR', libdir)
+    _write_makefile_key(f, 'BINDIR', libdir)
+    f.close()
+
+main()
+    
+
diff --git a/wpa_supplicant/Makefile b/wpa_supplicant/Makefile
index 1d66aa7..540909e 100644
--- a/wpa_supplicant/Makefile
+++ b/wpa_supplicant/Makefile
@@ -6,14 +6,18 @@ ifndef CFLAGS
 CFLAGS = -MMD -O2 -Wall -g
 endif
 
-export LIBDIR ?= /usr/local/lib/
-export BINDIR ?= /usr/local/sbin/
+export PREFIX ?= /usr/local
+export SYSCONFDIR ?= $(PREFIX)/etc
+export LIBDIR ?= $(PREFIX)/lib/
+export BINDIR ?= $(PREFIX)/sbin/
 PKG_CONFIG ?= pkg-config
 
 CFLAGS += -I../src
 CFLAGS += -I../src/utils
 
 -include .config
+# Generated by configure
+-include ../Makefile.inc
 
 BINALL=wpa_supplicant wpa_cli
 
@@ -49,10 +53,13 @@ mkconfig:
 	echo CONFIG_DRIVER_HOSTAP=y >> .config
 	echo CONFIG_DRIVER_WEXT=y >> .config
 
-$(DESTDIR)$(BINDIR)/%: %
-	install -D $(<) $(@)
+install-bin: $(BINALL)
+	@list='$(BINALL)'; \
+	for x in $$list; do install -D $$x $(DESTDIR)$(BINDIR)/$$x; done
 
-install: $(addprefix $(DESTDIR)$(BINDIR)/,$(BINALL))
+install-data::
+
+install:: install-bin install-data
 	$(MAKE) -C ../src install
 
 OBJS = config.o
@@ -1166,8 +1173,18 @@ endif
 OBJS += ctrl_iface.o ctrl_iface_$(CONFIG_CTRL_IFACE).o
 endif
 
+# This bit is necessary because we don't have an "or" construct
+DBUS_SYSTEM_CONFIG_FILE=dbus/dbus-wpa_supplicant.conf
+
 ifdef CONFIG_CTRL_IFACE_DBUS
 DBUS=y
+DBUS_SERVICE_FILE=dbus/fi.epitest.hostap.WPASupplicant.service
+install-data:: $(DBUS_SERVICE_FILE)
+	service_bn=$$(basename $(DBUS_SERVICE_FILE)); \
+	install -D $(DBUS_SERVICE_FILE) $(DESTDIR)$(PREFIX)/share/dbus-1/system-services/$$service_bn
+	system_config_bn=$$(basename $(DBUS_SYSTEM_CONFIG_FILE)); \
+	install -D $(DBUS_SYSTEM_CONFIG_FILE) $(DESTDIR)$(SYSCONFDIR)/dbus-1/system.d/$$system_config_bn
+ALL += dbus/fi.w1.wpa_supplicant1.service
 DBUS_CFLAGS += -DCONFIG_CTRL_IFACE_DBUS -DDBUS_API_SUBJECT_TO_CHANGE
 DBUS_OBJS += dbus/dbus_old.o dbus/dbus_old_handlers.o
 ifdef CONFIG_WPS
@@ -1185,6 +1202,12 @@ endif
 
 ifdef CONFIG_CTRL_IFACE_DBUS_NEW
 DBUS=y
+DBUS_SERVICE_FILE_NEW=dbus/fi.w1.wpa_supplicant1.service
+install-data:: $(DBUS_SERVICE_FILE_NEW)
+	bn=$$(basename $(DBUS_SERVICE_FILE_NEW)); \
+	install -D $(DBUS_SERVICE_FILE_NEW) $(DESTDIR)$(PREFIX)/share/dbus-1/system-services/$$bn
+	system_config_bn=$$(basename $(DBUS_SYSTEM_CONFIG_FILE)); \
+	install -D $(DBUS_SYSTEM_CONFIG_FILE) $(DESTDIR)$(SYSCONFDIR)/dbus-1/system.d/$$system_config_bn
 DBUS_CFLAGS += -DCONFIG_CTRL_IFACE_DBUS_NEW
 DBUS_OBJS ?= dbus/dbus_dict_helpers.o
 DBUS_OBJS += dbus/dbus_new_helpers.o
-- 
1.7.7.6

